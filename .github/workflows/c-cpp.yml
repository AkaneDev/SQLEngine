name: C/C++ CI & Release

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            runner: ubuntu-latest
            ext: tar.gz
          - os: macos-latest
            runner: macos-latest
            ext: tar.gz
          - os: windows-latest
            runner: windows-latest
            ext: zip

    steps:
    - uses: actions/checkout@v4

    - name: Install build tools
      if: matrix.os == 'ubuntu-latest'
      run: sudo apt update && sudo apt install -y build-essential automake

    - name: Install build tools
      if: matrix.os == 'macos-latest'
      run: brew install automake

    - name: Install build tools
      if: matrix.os == 'windows-latest'
      run: choco install make automake -y

    - name: Configure
      run: ./configure

    - name: Build
      run: make -j$(nproc)

    - name: Test
      run: make check || echo "Tests skipped/failures ignored"

    - name: Package
      run: |
        mkdir -p release
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          zip -r release/game-${{ matrix.os }}.${{ matrix.ext }} sqlEngine.exe
        else
          tar czf release/game-${{ matrix.os }}.${{ matrix.ext }} sqlEngine
        fi

    - name: Upload release asset
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.0
        name: game-${{ matrix.os }}.${{ matrix.ext }}
        asset_path: release/game-${{ matrix.os }}.${{ matrix.ext }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
